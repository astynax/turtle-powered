#!/usr/bin/env stack
-- stack --install-ghc runghc --package shake
import           Data.Maybe                 (fromMaybe)
import           Development.Shake
import           Development.Shake.FilePath

dir :: FilePath
dir = "bin"

build :: FilePath -> Action ()
build source = do
  putNormal $ "--- Building " ++ source ++ " ---"
  let target = dir </> source -<.> exe
  tmp <- fromMaybe "/tmp" <$> getEnv "TEMP"
  () <- cmd "stack ghc -- -O2 -odir" tmp "-hidir" tmp "-o" target source
  need [target]
  cmd "strip" target

main :: IO ()
main = shakeArgs shakeOptions {shakeFiles=dir} $ do

  phony "all" $ getDirectoryFiles "" ["*.hs"] >>= mapM_ build

  "*.hs" %> build
